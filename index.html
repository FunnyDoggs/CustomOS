<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OS Emulator</title>
</head>
<body>
  <pre id="output"></pre>
  <input type="text" id="cliInput" placeholder="Type a command">

  <script>
    class CPU {
      constructor() {
        this.registers = new Array(8).fill(0);
        this.memory = new Array(256).fill(0);
        this.programCounter = 0;
        this.fileSystem = new FileSystem();
        this.ram = new RAM();
        this.gpu = new GPU();
        this.currentDirectory = '/';
      }

      execute(instruction, argument) {
        switch (instruction) {
          case 'PRINT':
            this.print(argument);
            break;
          case 'ADD':
            this.add(argument[0], argument[1]);
            break;
          case 'READ_FILE':
            this.readFile(argument);
            break;
          case 'FORMAT':
            this.formatStorage();
            break;
          case 'MAKEDIR':
            this.makeDirectory(argument);
            break;
          case 'STATUS':
            this.displayStatus();
            break;
          case 'LIST_FILES':
            this.listFiles();
            break;
          case 'CHANGE_DIR':
            this.changeDirectory(argument);
            break;
          case 'WRITE_FILE':
            this.writeFile(argument[0], argument.slice(1).join(' '));
            break;
          case 'DELETE_FILE':
            this.deleteFile(argument);
            break;
          case 'EDIT_FILE':
            this.editFile(argument);
            break;
          // Add more cases as needed
          default:
            // Handle unknown instructions
            break;
        }
      }

      print(data) {
        const outputElement = document.getElementById('output');
        outputElement.textContent += String.fromCharCode(data);
      }

      add(operand1, operand2) {
        this.registers[0] = operand1 + operand2;
      }

      readFile(fileName) {
        const content = this.fileSystem.readFile(fileName, this.currentDirectory);
        this.print(content);
      }

      formatStorage() {
        this.fileSystem.format();
      }

      makeDirectory(dirName) {
        this.fileSystem.makeDirectory(dirName, this.currentDirectory);
      }

      displayStatus() {
        const outputElement = document.getElementById('output');
        outputElement.textContent += 'System Status:\n';
        outputElement.textContent += `Current Directory: ${this.currentDirectory}\n`;
        outputElement.textContent += `CPU Registers: ${this.registers.join(', ')}\n`;
        outputElement.textContent += `RAM Usage: ${this.ram.getUsage()}%\n`;
        outputElement.textContent += `GPU Status: ${this.gpu.getStatus()}\n`;
        outputElement.textContent += 'File System:\n';
        this.fileSystem.displayFileSystem();
      }

      listFiles() {
        const outputElement = document.getElementById('output');
        outputElement.textContent += 'Files and Directories in Current Directory:\n';
        this.fileSystem.displayFilesInDirectory(this.currentDirectory);
      }

      changeDirectory(targetDir) {
        const newDir = this.fileSystem.changeDirectory(targetDir, this.currentDirectory);
        if (newDir !== null) {
          this.currentDirectory = newDir;
        } else {
          const outputElement = document.getElementById('output');
          outputElement.textContent += `Directory '${targetDir}' not found.\n`;
        }
      }

      writeFile(fileName, content) {
        this.fileSystem.writeFile(fileName, content, this.currentDirectory);
        const outputElement = document.getElementById('output');
        outputElement.textContent += `Created file: ${fileName}\n`;
      }

      deleteFile(fileName) {
        this.fileSystem.deleteFile(fileName, this.currentDirectory);
        const outputElement = document.getElementById('output');
        outputElement.textContent += `Deleted file: ${fileName}\n`;
      }

      editFile(fileName) {
        const content = this.fileSystem.readFile(fileName, this.currentDirectory);
        const editorWindow = window.open('editor.html', 'Editor', 'width=600,height=400');
        
        editorWindow.addEventListener('DOMContentLoaded', function() {
          editorWindow.document.getElementById('editor').value = content;
        });

        editorWindow.addEventListener('message', function(event) {
          const editedContent = event.data;
          document.getElementById('output').textContent += `Edited file '${fileName}':\n`;
          document.getElementById('output').textContent += editedContent + '\n';

          // Update the content of the file in the file system
          cpu.fileSystem.writeFile(fileName, editedContent, cpu.currentDirectory);
        });
      }

      // (Other methods remain unchanged)

    }

    class OS {
      // (Your existing OS class code)
    }

    class FileSystem {
      // (Your existing FileSystem class code)

      deleteFile(fileName, currentDirectory) {
        const fullPath = this.getFullPath(fileName, currentDirectory);
        this.storage.removeItem(fullPath);
      }

      // (Other methods remain unchanged)
    }

    class RAM {
      constructor() {
        this.contents = [];
      }

      addToRAM(data) {
        if (this.contents.length >= 256) {
          this.emptyRAM();
        }
        this.contents.push(data);
      }

      emptyRAM() {
        this.contents = [];
        const outputElement = document.getElementById('output');
        outputElement.textContent += 'RAM overflowed. Contents emptied.\n';
      }

      getUsage() {
        return (this.contents.length / 256) * 100;
      }
    }

    class GPU {
      // (Your existing GPU class code)
    }

    const cpu = new CPU();
    const os = new OS(cpu);

    const cliInput = document.getElementById('cliInput');
    cliInput.addEventListener('input', function (event) {
      const trimmedValue = cliInput.value.trim();
      if (event.inputType === 'insertLineBreak' || event.inputType === 'insertParagraph') {
        cliInput.value = ''; // Clear the input if Enter key is pressed
        handleCommand(trimmedValue);
        event.preventDefault();
      }
    });

    function executeCommand() {
      const command = cliInput.value.trim();
      handleCommand(command);
      cliInput.value = '';
    }

    function handleCommand(command) {
      const args = command.split(' ');
      const commandName = args[0].toUpperCase();

      switch (commandName) {
        // (Other command cases remain unchanged)
        case 'DELETE_FILE':
          const fileToDelete = args[1];
          cpu.execute('DELETE_FILE', fileToDelete);
          break;
        // (Other command cases remain unchanged)
      }
    }

    function clearOutput() {
      const outputElement = document.getElementById('output');
      outputElement.textContent = '';
    }

    function showHelp() {
      const outputElement = document.getElementById('output');
      outputElement.textContent += 'Available Commands:\n';
      outputElement.textContent += '- WRITE_FILE <filename> <content>: Write content to a file\n';
      outputElement.textContent += '- DELETE_FILE <filename>: Delete a file\n';
      outputElement.textContent += '- READ_FILE <filename>: Read content from a file\n';
      outputElement.textContent += '- FORMAT: Format the storage (clear all files)\n';
      outputElement.textContent += '- MAKEDIR <dirname>: Create a new directory\n';
      outputElement.textContent += '- LIST_FILES: Display the list of files and directories\n';
      outputElement.textContent += '- CD <dirname>: Change the current directory\n';
      outputElement.textContent += '- EDIT_FILE <filename>: Edit the content of a file\n';
      outputElement.textContent += '- STATUS: Display system status\n';
      outputElement.textContent += '- CLEAR: Clear the output area\n';
      outputElement.textContent += '- HELP: Display this help message\n';
    }
  </script>
</body>
</html>
